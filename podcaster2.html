 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BingePlay — Audiobooks (LibriVox) & Podcasts</title>
  <style>
    :root{
      --bg:#071022; --muted:#9fb1c6; --accent:#06b6d4; --card:rgba(255,255,255,0.03);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    body{margin:0;background:linear-gradient(180deg,#041426,#07192a);color:#eaf6ff}
    .wrap{max-width:1150px;margin:28px auto;padding:20px;}
    header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    header h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    .list{display:flex;flex-direction:column;gap:8px;max-height:480px;overflow:auto;padding-right:6px}
    .item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;cursor:pointer;transition:all .12s}
    .item:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,0.45)}
    .thumb{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#5563d6);display:flex;align-items:center;justify-content:center;font-weight:700}
    .meta{flex:1;min-width:0}
    .title{font-weight:700}
    .desc{font-size:13px;color:var(--muted);margin-top:4px}
    .playbtn{padding:6px 10px;border-radius:8px;background:var(--card);border:1px solid rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
    audio{width:100%;margin-top:8px}
    .small{font-size:12px;color:var(--muted)}
    iframe{width:100%;height:150px;border-radius:12px;border:0}
    footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}.list{max-height:320px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#7c3aed,#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700">BP</div>
      <div>
        <h1>BingePlay — Audiobooks (LibriVox) & Podcasts</h1>
        <div class="small">Click any audiobook — the site will fetch the real LibriVox MP3 and play it.</div>
      </div>
    </header>

    <div class="grid">
      <!-- left column: lists -->
      <div>
        <div class="panel" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Audiobooks — 15 titles (LibriVox)</strong>
            <div class="small">Each click fetches a real MP3 from LibriVox.</div>
          </div>
          <div class="list" id="audiobookList" role="listbox" aria-label="Audiobooks list">
            <!-- generated by JS -->
          </div>
        </div>

        <div class="panel" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Public-domain Podcasts / Old-Time Radio (playable)</strong>
            <div class="small">Direct MP3s</div>
          </div>
          <div class="list" id="publicPodcastList"></div>
        </div>

        <div class="panel" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Top Podcasts (Embedded players)</strong>
            <div class="small">Official players — press Play inside them</div>
          </div>
          <div class="list" id="embedList"></div>
        </div>

        <div class="panel" id="embedContainer" style="min-height:120px;display:flex;align-items:center;justify-content:center;color:var(--muted)">
          Click an embedded podcast above to load the official player here.
        </div>
      </div>

      <!-- right column: player -->
      <div>
        <div class="panel">
          <div style="display:flex;gap:12px;align-items:center;">
            <div id="playerThumb" style="width:72px;height:72px;border-radius:10px;background:linear-gradient(135deg,#06b6d4,#334155);display:flex;align-items:center;justify-content:center;font-weight:700">♪</div>
            <div style="flex:1">
              <div id="playerTitle" style="font-weight:700">Nothing playing</div>
              <div id="playerSub" class="desc">Click an audiobook or podcast to play</div>
            </div>
          </div>

          <audio id="mainAudio" controls preload="none">
            <source id="audioSource" src="" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div>
              <button id="stopBtn" class="playbtn">Stop</button>
              <button id="pauseBtn" class="playbtn" style="margin-left:8px">Pause</button>
            </div>
            <div class="small">LibriVox API used to fetch tracks live (JSONP)</div>
          </div>

          <div id="status" class="small" style="margin-top:8px;color:var(--muted)"></div>
        </div>
      </div>
    </div>

    <footer>Demo uses public-domain audio (LibriVox, Internet Archive) and official Spotify embeds for mainstream shows.</footer>
  </div>

  <script>
  /**************************************************************************
   * APPROACH
   * - This page lists 15 audiobook titles (LibriVox). When the user clicks a
   *   title, the client uses LibriVox's API via JSONP to:
   *     1) find the best-matching book (project)
   *     2) request audiotracks for that project
   *     3) pick the first available MP3 track URL and play it
   *
   * - JSONP avoids CORS issues: we add a script tag with &format=jsonp&callback=...
   * - If any step fails we show a clear error in #status.
   *
   * IMPORTANT: Embedded Spotify players still require the user to click Play
   * inside the widget (autoplay blocked by browsers / Spotify).
   **************************************************************************/

  const audiobookTitles = [
    "Dracula Bram Stoker",
    "Pride and Prejudice Jane Austen",
    "Moby Dick Herman Melville",
    "Frankenstein Mary Shelley",
    "A Scandal in Bohemia Arthur Conan Doyle",
    "Alice's Adventures in Wonderland Lewis Carroll",
    "The Adventures of Tom Sawyer Mark Twain",
    "Adventures of Huckleberry Finn Mark Twain",
    "Jane Eyre Charlotte Bronte",
    "Emma Jane Austen",
    "Treasure Island R L Stevenson",
    "Great Expectations Charles Dickens",
    "The Picture of Dorian Gray Oscar Wilde",
    "Strange Case of Dr Jekyll and Mr Hyde Robert Louis Stevenson",
    "The War of the Worlds H G Wells"
  ];

  // public-domain OTR / Internet Archive playable examples (direct mp3s)
  const publicPodcasts = [
    { title: "X Minus One – The Martian Death March", subtitle: "Old-Time Sci-Fi (IA)", art: "XR", src: "https://ia800905.us.archive.org/17/items/OTRR_XMinusOne_Singles/XMinusOne_560424_TheMartianDeathMarch.mp3" },
    { title: "Escape – The Devil and the Demon", subtitle: "Radio Drama (IA)", art: "RD", src: "https://archive.org/download/OTRR_Escape_Singles/Escape_47-05-10_The_Devil_and_the_Demon.mp3" },
    { title: "Pearl Harbor Address (Historic Broadcast)", subtitle:"Historic (IA)", art:"HS", src:"https://ia803207.us.archive.org/17/items/WorldWarII_733/WWII-1941-12-09-PearlHarborAddress.mp3" }
  ];

  // embeds (Spotify). They load in the embed container. User must press Play in the widget.
  const embeds = [
    { title:"The Joe Rogan Experience (Spotify)", embedHtml:`<iframe src="https://open.spotify.com/embed/show/4rOoJ6Egrf8K2IrywzwOMk" width="100%" height="152" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture"></iframe>` },
    { title:"This American Life (Spotify)", embedHtml:`<iframe src="https://open.spotify.com/embed/show/2XcYt6OsY0GHyFmgBd0F5i" width="100%" height="152" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture"></iframe>` },
    { title:"The Daily (Spotify)", embedHtml:`<iframe src="https://open.spotify.com/embed/show/2GmQ7U4JV7JNXoRmz54XfM" width="100%" height="152" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture"></iframe>` }
  ];

  // DOM refs
  const audiobookList = document.getElementById('audiobookList');
  const publicPodcastList = document.getElementById('publicPodcastList');
  const embedList = document.getElementById('embedList');
  const embedContainer = document.getElementById('embedContainer');
  const mainAudio = document.getElementById('mainAudio');
  const audioSource = document.getElementById('audioSource');
  const playerTitle = document.getElementById('playerTitle');
  const playerSub = document.getElementById('playerSub');
  const playerThumb = document.getElementById('playerThumb');
  const statusEl = document.getElementById('status');
  const stopBtn = document.getElementById('stopBtn');
  const pauseBtn = document.getElementById('pauseBtn');

  // create audiobook list UI
  audiobookTitles.forEach((t, idx) => {
    const el = document.createElement('div');
    el.className = 'item';
    el.tabIndex = 0;
    const art = (t.match(/\b([A-Z])[a-z]+/g) || []).slice(0,2).map(s=>s[0]).join('').slice(0,2).toUpperCase() || 'AB';
    el.innerHTML = `<div class="thumb">${art}</div>
      <div class="meta"><div class="title">${t}</div><div class="desc small">Click to fetch from LibriVox and play</div></div>
      <button class="playbtn">Play</button>`;
    // click handler
    el.addEventListener('click', (e)=> {
      // if clicked on Play button the event will bubble; we handle same
      fetchAndPlayFromLibriVox(t);
    });
    // keyboard
    el.addEventListener('keypress', (ev)=>{ if(ev.key === 'Enter'){ fetchAndPlayFromLibriVox(t); }});
    audiobookList.appendChild(el);
  });

  // populate public podcasts
  publicPodcasts.forEach(p => {
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `<div class="thumb">${p.art}</div>
      <div class="meta"><div class="title">${p.title}</div><div class="desc">${p.subtitle}</div></div>
      <button class="playbtn">Play</button>`;
    el.addEventListener('click', ()=> playDirectAudio(p.src, p.title, p.subtitle, p.art));
    el.querySelector('.playbtn').addEventListener('click', (e)=> { e.stopPropagation(); playDirectAudio(p.src, p.title, p.subtitle, p.art); });
    publicPodcastList.appendChild(el);
  });

  // populate embeds
  embeds.forEach(e=>{
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `<div class="thumb">SP</div><div class="meta"><div class="title">${e.title}</div></div>`;
    el.addEventListener('click', ()=> {
      embedContainer.innerHTML = e.embedHtml;
      embedContainer.scrollIntoView({behavior:'smooth', block:'center'});
      status('Loaded embed: ' + e.title + '. Press Play inside the widget (Spotify blocks autoplay).');
    });
    embedList.appendChild(el);
  });

  // status helper
  function status(txt, isError=false){
    statusEl.textContent = txt || '';
    statusEl.style.color = isError ? '#ffb4b4' : 'var(--muted)';
  }

  // play direct mp3 (Internet Archive items etc.)
  function playDirectAudio(url, title, subtitle, art){
    audioSource.src = url;
    mainAudio.load();
    mainAudio.play().then(()=>{
      playerTitle.textContent = title;
      playerSub.textContent = subtitle;
      playerThumb.textContent = art || '♪';
      status('Playing: ' + title);
    }).catch(err=>{
      playerTitle.textContent = title;
      playerSub.textContent = subtitle + ' (click Play if browser blocked autoplay)';
      playerThumb.textContent = art || '♪';
      status('Playback blocked by browser. Click Play in the audio control.', true);
      console.warn('playDirectAudio error', err);
    });
  }

  // Stop / Pause controls
  stopBtn.addEventListener('click', ()=> {
    try{ mainAudio.pause(); mainAudio.currentTime = 0; }catch(e){}
    audioSource.src = '';
    mainAudio.load();
    playerTitle.textContent = 'Nothing playing';
    playerSub.textContent = 'Click any audiobook or podcast to play';
    playerThumb.textContent = '♪';
    status('');
  });
  pauseBtn.addEventListener('click', ()=> { try{ mainAudio.pause(); }catch(e){} });

  /*************************************************************************
   * LIBRIVOX JSONP HELPERS
   *
   * We'll use JSONP for the Librivox catalog API requests to avoid CORS:
   *  - search:  https://librivox.org/api/feed/audiobooks/?title=...&format=jsonp&callback=CALLBACK
   *  - tracks:  https://librivox.org/api/feed/audiotracks/?project_id=PROJECTID&format=jsonp&callback=CALLBACK
   *
   * We create <script> tags with dynamic callback names and resolve via Promises.
   *************************************************************************/

  let jsonpCounter = 0;
  function jsonpFetch(url, timeout = 10000) {
    return new Promise((resolve, reject) => {
      const callbackName = '__lp_cb_' + (jsonpCounter++);
      const timedOut = setTimeout(()=> {
        window[callbackName] = ()=>{};
        cleanup();
        reject(new Error('JSONP timeout for ' + url));
      }, timeout);

      function cleanup(){
        clearTimeout(timedOut);
        const s = document.getElementById(callbackName);
        if(s) s.remove();
        try{ delete window[callbackName]; } catch(e){ window[callbackName] = undefined; }
      }

      window[callbackName] = function(data){
        cleanup();
        resolve(data);
      };

      const script = document.createElement('script');
      script.id = callbackName;
      // Ensure format=jsonp and callback param is correct:
      const sep = url.includes('?') ? '&' : '?';
      script.src = url + sep + 'format=jsonp&callback=' + callbackName;
      script.onerror = function(e){
        cleanup();
        reject(new Error('JSONP load error for ' + url));
      };
      document.body.appendChild(script);
    });
  }

  /**
   * fetchAndPlayFromLibriVox(title)
   * 1) Query librivox audiobooks search for title => respons.books
   * 2) Choose the first matching book, get its project ID (book.id)
   * 3) Query audiotracks with project_id => returns track list with direct URLs
   * 4) Play the first available track (mp3) from track.url or track.url_download
   */
  async function fetchAndPlayFromLibriVox(title) {
    status('Searching LibriVox for "' + title + '" ...');
    playerTitle.textContent = 'Loading...';
    playerSub.textContent = 'Searching LibriVox for: ' + title;
    playerThumb.textContent = '…';

    try {
      // 1) search for book
      const searchUrl = 'https://librivox.org/api/feed/audiobooks/?title=' + encodeURIComponent(title);
      const searchData = await jsonpFetch(searchUrl);
      if(!searchData || !searchData.books){
        throw new Error('No search results from LibriVox for "' + title + '"');
      }

      // books is an object keyed by numeric keys; pick the first key
      const bookKeys = Object.keys(searchData.books);
      if(bookKeys.length === 0){
        throw new Error('No LibriVox book entries found for "' + title + '"');
      }
      const firstKey = bookKeys[0];
      const book = searchData.books[firstKey];
      const projectId = book.id || book.project_id || book.catalog_number || null;
      const bookTitle = (book.title || title);
      if(!projectId){
        // some older API responses put the id in a nested structure; fallback: try reading "id" prop
        throw new Error('Could not get LibriVox project id for "' + title + '"');
      }

      status('Found "' + bookTitle + '" (project ' + projectId + '). Loading tracks ...');

      // 2) fetch tracks for that project
      const tracksUrl = 'https://librivox.org/api/feed/audiotracks/?project_id=' + encodeURIComponent(projectId);
      const tracksData = await jsonpFetch(tracksUrl);
      if(!tracksData || !tracksData.tracks){
        throw new Error('No tracks returned from LibriVox for project ' + projectId);
      }

      const trackKeys = Object.keys(tracksData.tracks);
      if(trackKeys.length === 0){
        throw new Error('No tracks available for "' + bookTitle + '"');
      }

      // prefer mp3/128k if available; otherwise take first track url field
      let chosenUrl = null;
      let chosenTrackTitle = null;
      for(const k of trackKeys){
        const t = tracksData.tracks[k];
        // the API track object typically includes "url" (mp3/stream) and "url_text_source" or "url_m4b"; we'll try common fields
        if(t.url && typeof t.url === 'string' && t.url.endsWith('.mp3')){ chosenUrl = t.url; chosenTrackTitle = t.title || ''; break; }
        if(t.url_text_source && typeof t.url_text_source === 'string' && t.url_text_source.endsWith('.mp3')){ chosenUrl = t.url_text_source; chosenTrackTitle = t.title || ''; break; }
        if(t.url_download && typeof t.url_download === 'string' && t.url_download.endsWith('.mp3')){ chosenUrl = t.url_download; chosenTrackTitle = t.title || ''; break; }
      }
      // if still not found, fallback to first track object's first available URL-like field
      if(!chosenUrl){
        const t0 = tracksData.tracks[trackKeys[0]];
        // try common fields:
        chosenUrl = t0.url || t0.url_text_source || t0.url_download || null;
        chosenTrackTitle = t0.title || '';
      }

      if(!chosenUrl){
        throw new Error('Could not find an MP3 URL in LibriVox tracks for "' + bookTitle + '"');
      }

      // 3) play it
      playerTitle.textContent = bookTitle;
      playerSub.textContent = (chosenTrackTitle ? (chosenTrackTitle + ' — ') : '') + ('Playing via LibriVox (project ' + projectId + ')');
      playerThumb.textContent = (bookTitle.split(' ').slice(0,2).map(s=>s[0]).join('') || 'AB').toUpperCase();

      // set audio source and play
      audioSource.src = chosenUrl;
      mainAudio.load();
      try {
        await mainAudio.play();
        status('Playing: ' + bookTitle + ' — ' + (chosenTrackTitle || 'Track 1'));
      } catch(playErr){
        // autoplay may be blocked — inform user and update UI
        status('Playback started? If blocked by browser, please press Play in the audio control.', true);
        console.warn('Autoplay blocked or play error:', playErr);
      }

    } catch(err){
      console.error('LibriVox fetch/play error:', err);
      status('Error: ' + (err && err.message ? err.message : String(err)), true);
      playerTitle.textContent = 'Error loading';
      playerSub.textContent = (err && err.message) ? err.message : 'Unknown error';
      playerThumb.textContent = '!';
    }
  }

  /*
   * Safety: ensure only one audio plays if other audio elements appear
   */
  document.addEventListener('play', function(e){
    const audios = document.getElementsByTagName('audio');
    for(let i=0;i<audios.length;i++) if(audios[i] !== e.target) audios[i].pause();
  }, true);

  // Convenience: when audio ends, show finished
  mainAudio.addEventListener('ended', ()=> {
    status('Finished playing');
  });

  </script>
</body>
</html>
